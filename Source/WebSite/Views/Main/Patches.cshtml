@*******************************************************************************************************
//  Patches.cshtml - Gbtc
//
//  Copyright © 2016, Grid Protection Alliance.  All Rights Reserved.
//
//  Licensed to the Grid Protection Alliance (GPA) under one or more contributor license agreements. See
//  the NOTICE file distributed with this work for additional information regarding copyright ownership.
//  The GPA licenses this file to you under the MIT License (MIT), the "License"; you may not use this
//  file except in compliance with the License. You may obtain a copy of the License at:
//
//      http://opensource.org/licenses/MIT
//
//  Unless agreed to in writing, the subject software distributed under the License is distributed on an
//  "AS-IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. Refer to the
//  License for the specific language governing permissions and limitations.
//
//  Code Modification History:
//  ----------------------------------------------------------------------------------------------------
//  02/20/2016 - Ritchie Carroll
//       Generated original version of source code.
//
//*****************************************************************************************************@
@using System.Text
@using openSPM.Models
@model AppModel
@{    
    ViewBag.PageName = "Patches";
    ViewBag.PageControlScripts = new StringBuilder();

    // Define column headers, use null for field name to make column non-sortable
    ViewBag.HeaderColumns = new[]
    {   //    { "Field", "Label", "Classes" }
        new[] { "SPMidentifier", "SPM&nbsp;ID", "text-center" },
        new[] { "ImpactValue", "Impact", "text-center" },
        new[] { "Title", "Title", "text-left" },
        new[] { "dtSubmitted", "Submitted", "text-center" }
    };

    DataContext dataContext = ViewBag.DataContext;
    int impactValuesID = dataContext.Connection.ExecuteScalar<int?>("SELECT ID FROM ValueListGroup WHERE name='impact' AND enabled <> 0") ?? 0;

    ViewBag.ImpactValuesID = impactValuesID;
    ViewBag.BodyRows = BodyRows().ToString();
    ViewBag.AddNewEditDialog = AddNewEditDialog().ToString();
}
@helper BodyRows()
{
    <td width="20%" class="text-center valign-middle" nowrap><button type="button" class="btn btn-link" data-bind="text: SPMidentifier, click: $parent.viewPageRecord"></button></td>
    <td width="15%" class="text-center valign-middle" data-bind="text: lookupImpactValue(ImpactValue)"></td>
    <td width="50%" class="text-left table-cell-hard-wrap"><div data-bind="text: $($element.parentElement).truncateToWidth(Title, 1.5), attr: {title: Title}"></div></td>
    <td width="10%" class="text-center valign-middle" data-bind="text: dtSubmitted.formatDate(DateFormat)"></td>
    <td width="5%" class="text-center valign-middle" nowrap>
        <button type="button" class="btn btn-xs" data-bind="click: $parent.editPageRecord, enable: $parent.dataHubIsConnected"><span class="glyphicon glyphicon-pencil"></span></button>
        <button type="button" class="btn btn-xs" data-bind="click: $parent.removePageRecord, enable: $parent.dataHubIsConnected"><span class="glyphicon glyphicon-remove"></span></button>
    </td>
}
@helper AddNewEditDialog()
{
    DataContext dataContext = ViewBag.DataContext;
    RecordRestriction impactValues = new RecordRestriction {
        FilterExpression = "GroupID = {0} AND enabled <> 0 AND private = 0",
        Parameters = new object[] { ViewBag.ImpactValuesID }
    };

    <div class="col-md-4">
        @Html.Raw(dataContext.AddInputField<Patch>("SPMidentifier"))
        @Html.Raw(dataContext.AddSelectField<Patch, Patch>("ParentID", "ID", "SPMidentifier"))
        @Html.Raw(dataContext.AddSelectField<Patch, Patch>("SourceID", "ID", "SPMidentifier"))
        @Html.Raw(dataContext.AddInputField<Patch>("SourceIdentifier"))
        @Html.Raw(dataContext.AddDateField<Patch>("dtSource"))
        @Html.Raw(dataContext.AddSelectField<Patch, ValueList>("ImpactValue", "intValue", "name", "sortOrder", restriction: impactValues))
        @Html.Raw(dataContext.AddDateField<Patch>("dtSubmitted"))
    </div>
    <div class="col-md-4">
        @Html.Raw(dataContext.AddInputField<Patch>("Title"))
        @Html.Raw(dataContext.AddTextAreaField<Patch>("Target"))
        @Html.Raw(dataContext.AddTextAreaField<Patch>("Summary"))
        @Html.Raw(dataContext.AddTextAreaField<Patch>("Detail", 3))
        @Html.Raw(dataContext.AddTextAreaField<Patch>("Reference"))
    </div>
    <div class="col-md-4">
        @Html.Raw(dataContext.AddTextAreaField<Patch>("WorkArounds"))
        @Html.Raw(dataContext.AddInputField<Patch>("Link", "url"))
        @Html.Raw(dataContext.AddInputField<Patch>("AlarmCriticalDays"))
        @Html.Raw(dataContext.AddTextAreaField<Patch>("CloseOutNotes", 4))
        @Html.Raw(dataContext.AddCheckBoxField<Patch>("isNotCompliance"))
    </div>
}
@Html.Partial("PagedViewModel")
@section Scripts {
    @Html.Raw(ViewBag.PageControlScripts.ToString())
    <script>
        // Configure view model
        viewModel.defaultSortField = "ID";
        viewModel.labelField = "SPMidentifier";
        viewModel.primaryKeyFields = ["ID"];
        viewModel.initialFocusField = "inputSPMidentifier";

        viewModel.setQueryRecordCount(function() {
            return dataHub.queryPatchCount();
        });

        viewModel.setQueryRecords(function(sortField, ascending, page, pageSize) {
            return dataHub.queryPatches(sortField, ascending, page, pageSize);
        });

        viewModel.setDeleteRecord(function(keyValues) {
            return dataHub.deletePatch(keyValues[0]);
        });

        viewModel.setNewRecord(function() {
            return dataHub.newPatch();
        });

        viewModel.setAddNewRecord(function(record) {
            return dataHub.addNewPatch(record);
        });

        viewModel.setUpdateRecord(function(record) {
            return dataHub.updatePatch(record);
        });

        // Define Javascript based impact value lookup function
        var impactValues = [];

        @foreach (ValueList valueList in dataContext.QueryRecords<ValueList>("SELECT ID FROM ValueList WHERE GroupID = {0} AND enabled <> 0 AND private = 0", impactValuesID)) {
            @:impactValues[@valueList.intValue] = "@valueList.name.JavaScriptEncode()";
        }

        function lookupImpactValue(value) {
            return impactValues[value];
        }
    </script>
}